// Reference: 4-1 in Intel's 8080 Microprocessor System User's Manual

//#include <sys/types.h>
#include <sys/stat.h> // fstat
#include <fcntl.h> // open
#include <stdio.h> // printf
#include <sys/mman.h> // mmap

struct OP {
	int size;
	char *fmt;
} const lookup[256] = {
		[0x00] = {1, "NOP"},
		[0x01] = {3, "LXI B,$%02x%02x"},
		[0x02] = {1, "STAX B"},
		[0x03] = {1, "INX B"},
		[0x04] = {1, "INR B"},
		[0x05] = {1, "DCR B"},
		[0x06] = {2, "MVI B, $%02x"},
		[0x07] = {1, "RLC"},
		[0x08] = {1, "-"},
		[0x09] = {1, "DAD B"},
		[0x0a] = {1, "LDAX B"},
		[0x0b] = {1, "DCX B"},
		[0x0c] = {1, "INR C"},
		[0x0d] = {1, "DCR C"},
		[0x0e] = {2, "MVI C,$%02x"},
		[0x0f] = {1, "RRC"},
		[0x10] = {1, "-"},
		[0x11] = {3, "LXI D,$%02x%02x"},
		[0x12] = {1, "STAX D"},
		[0x13] = {1, "INX D"},
		[0x14] = {1, "INR D"},
		[0x15] = {1, "DCR D"},
		[0x16] = {2, "MVI D, $%02x"},
		[0x17] = {1, "RAL"},
		[0x18] = {1, "-"},
		[0x19] = {1, "DAD D"},
		[0x1a] = {1, "LDAX D"},
		[0x1b] = {1, "DCX D"},
		[0x1c] = {1, "INR E"},
		[0x1d] = {1, "DCR E"},
		[0x1e] = {2, "MVI E,$%02x"},
		[0x1f] = {1, "RAR"},
		[0x20] = {1, "RIM"},
		[0x21] = {3, "LXI H,$%02x%02x"},
		[0x22] = {3, "SHLD #$%02x%02x"},
		[0x23] = {1, "INX H"},
		[0x24] = {1, "INR H"},
		[0x25] = {1, "DCR H"},
		[0x26] = {2, "MVI H,$%02x"},
		[0x27] = {1, "DAA"},
		[0x28] = {1, "-"},
		[0x29] = {1, "DAD H"},
		[0x2a] = {3, "LHLD #$%02x%02x"},
		[0x2b] = {1, "DCX H"},
		[0x2c] = {1, "INR L"},
		[0x2d] = {1, "DCR L"},
		[0x2e] = {2, "MVI L, $%02x"},
		[0x2f] = {1, "CMA"},
		[0x30] = {1, "SIM"},
		[0x31] = {3, "LXI SP, $%02x%02x"},
		[0x32] = {3, "STA #$%02x%02x"},
		[0x33] = {1, "INX SP"},
		[0x34] = {1, "INR M"},
		[0x35] = {1, "DCR M"},
		[0x36] = {2, "MVI M,$%02x"},
		[0x37] = {1, "STC"},
		[0x38] = {1, "-"},
		[0x39] = {1, "DAD SP"},
		[0x3a] = {3, "LDA #$%02x%02x"},
		[0x3b] = {1, "DCX SP"},
		[0x3c] = {1, "INR A"},
		[0x3d] = {1, "DCR A"},
		[0x3e] = {2, "MVI A,$%02x"},
		[0x3f] = {1, "CMC"},
		[0x40] = {1, "MOV B,B"},
		[0x41] = {1, "MOV B,C"},
		[0x42] = {1, "MOV B,D"},
		[0x43] = {1, "MOV B,E"},
		[0x44] = {1, "MOV B,H"},
		[0x45] = {1, "MOV B,L"},
		[0x46] = {1, "MOV B,M"},
		[0x47] = {1, "MOV B,A"},
		[0x48] = {1, "MOV C,B"},
		[0x49] = {1, "MOV C,C"},
		[0x4a] = {1, "MOV C,D"},
		[0x4b] = {1, "MOV C,E"},
		[0x4c] = {1, "MOV C,H"},
		[0x4d] = {1, "MOV C,L"},
		[0x4e] = {1, "MOV C,M"},
		[0x4f] = {1, "MOV C,A"},
		[0x50] = {1, "MOV D,B"},
		[0x51] = {1, "MOV D,C"},
		[0x52] = {1, "MOV D,D"},
		[0x53] = {1, "MOV D,E"},
		[0x54] = {1, "MOV D,H"},
		[0x55] = {1, "MOV D,L"},
		[0x56] = {1, "MOV D,M"},
		[0x57] = {1, "MOV D,A"},
		[0x58] = {1, "MOV E,B"},
		[0x59] = {1, "MOV E,C"},
		[0x5a] = {1, "MOV E,D"},
		[0x5b] = {1, "MOV E,E"},
		[0x5c] = {1, "MOV E,H"},
		[0x5d] = {1, "MOV E,L"},
		[0x5e] = {1, "MOV E,M"},
		[0x5f] = {1, "MOV E,A"},
		[0x60] = {1, "MOV H,B"},
		[0x61] = {1, "MOV H,C"},
		[0x62] = {1, "MOV H,D"},
		[0x63] = {1, "MOV H,E"},
		[0x64] = {1, "MOV H,H"},
		[0x65] = {1, "MOV H,L"},
		[0x66] = {1, "MOV H,M"},
		[0x67] = {1, "MOV H,A"},
		[0x68] = {1, "MOV L,B"},
		[0x69] = {1, "MOV L,C"},
		[0x6a] = {1, "MOV L,D"},
		[0x6b] = {1, "MOV L,E"},
		[0x6c] = {1, "MOV L,H"},
		[0x6d] = {1, "MOV L,L"},
		[0x6e] = {1, "MOV L,M"},
		[0x6f] = {1, "MOV L,A"},
		[0x70] = {1, "MOV M,B"},
		[0x71] = {1, "MOV M,C"},
		[0x72] = {1, "MOV M,D"},
		[0x73] = {1, "MOV M,E"},
		[0x74] = {1, "MOV M,H"},
		[0x75] = {1, "MOV M,L"},
		[0x76] = {1, "HLT"},
		[0x77] = {1, "MOV M,A"},
		[0x78] = {1, "MOV A,B"},
		[0x79] = {1, "MOV A,C"},
		[0x7a] = {1, "MOV A,D"},
		[0x7b] = {1, "MOV A,E"},
		[0x7c] = {1, "MOV A,H"},
		[0x7d] = {1, "MOV A,L"},
		[0x7e] = {1, "MOV A,M"},
		[0x7f] = {1, "MOV A,A"},
		[0x80] = {1, "ADD B"},
		[0x81] = {1, "ADD C"},
		[0x82] = {1, "ADD D"},
		[0x83] = {1, "ADD E"},
		[0x84] = {1, "ADD H"},
		[0x85] = {1, "ADD L"},
		[0x86] = {1, "ADD M"},
		[0x87] = {1, "ADD A"},
		[0x88] = {1, "ADC B"},
		[0x89] = {1, "ADC C"},
		[0x8a] = {1, "ADC D"},
		[0x8b] = {1, "ADC E"},
		[0x8c] = {1, "ADC H"},
		[0x8d] = {1, "ADC L"},
		[0x8e] = {1, "ADC M"},
		[0x8f] = {1, "ADC A"},
		[0x90] = {1, "SUB B"},
		[0x91] = {1, "SUB C"},
		[0x92] = {1, "SUB D"},
		[0x93] = {1, "SUB E"},
		[0x94] = {1, "SUB H"},
		[0x95] = {1, "SUB L"},
		[0x96] = {1, "SUB M"},
		[0x97] = {1, "SUB A"},
		[0x98] = {1, "SBB B"},
		[0x99] = {1, "SBB C"},
		[0x9a] = {1, "SBB D"},
		[0x9b] = {1, "SBB E"},
		[0x9c] = {1, "SBB H"},
		[0x9d] = {1, "SBB L"},
		[0x9e] = {1, "SBB M"},
		[0x9f] = {1, "SBB A"},
		[0xa0] = {1, "ANA B"},
		[0xa1] = {1, "ANA C"},
		[0xa2] = {1, "ANA D"},
		[0xa3] = {1, "ANA E"},
		[0xa4] = {1, "ANA H"},
		[0xa5] = {1, "ANA L"},
		[0xa6] = {1, "ANA M"},
		[0xa7] = {1, "ANA A"},
		[0xa8] = {1, "XRA B"},
		[0xa9] = {1, "XRA C"},
		[0xaa] = {1, "XRA D"},
		[0xab] = {1, "XRA E"},
		[0xac] = {1, "XRA H"},
		[0xad] = {1, "XRA L"},
		[0xae] = {1, "XRA M"},
		[0xaf] = {1, "XRA A"},
		[0xb0] = {1, "ORA B"},
		[0xb1] = {1, "ORA C"},
		[0xb2] = {1, "ORA D"},
		[0xb3] = {1, "ORA E"},
		[0xb4] = {1, "ORA H"},
		[0xb5] = {1, "ORA L"},
		[0xb6] = {1, "ORA M"},
		[0xb7] = {1, "ORA A"},
		[0xb8] = {1, "CMP B"},
		[0xb9] = {1, "CMP C"},
		[0xba] = {1, "CMP D"},
		[0xbb] = {1, "CMP E"},
		[0xbc] = {1, "CMP H"},
		[0xbd] = {1, "CMP L"},
		[0xbe] = {1, "CMP M"},
		[0xbf] = {1, "CMP A"},
		[0xc0] = {1, "RNZ"},
		[0xc1] = {1, "POP B"},
		[0xc2] = {3, "JNZ #$%02x%02x"},
		[0xc3] = {3, "JMP #$%02x%02x"},
		[0xc4] = {3, "CNZ #$%02x%02x"},
		[0xc5] = {1, "PUSH B"},
		[0xc6] = {2, "ADI $%02x"},
		[0xc7] = {1, "RST 0"},
		[0xc8] = {1, "RZ"},
		[0xc9] = {1, "RET"},
		[0xca] = {3, "JZ #$%02x%02x"},
		[0xcb] = {1, "-"},
		[0xcc] = {3, "CZ #$%02x%02x"},
		[0xcd] = {3, "CALL #$%02x%02x"},
		[0xce] = {2, "ACI $%02x"},
		[0xcf] = {1, "RST 1"},
		[0xd0] = {1, "RNC"},
		[0xd1] = {1, "POP D"},
		[0xd2] = {3, "JNC #$%02x%02x"},
		[0xd3] = {2, "OUT $%02x"},
		[0xd4] = {3, "CNC #$%02x%02x"},
		[0xd5] = {1, "PUSH D"},
		[0xd6] = {2, "SUI $%02x"},
		[0xd7] = {1, "RST 2"},
		[0xd8] = {1, "RC"},
		[0xd9] = {1, "-"},
		[0xda] = {3, "JC #$%02x%02x"},
		[0xdb] = {2, "IN $%02x"},
		[0xdc] = {3, "CC #$%02x%02x"},
		[0xdd] = {1, "-"},
		[0xde] = {2, "SBI $%02x"},
		[0xdf] = {1, "RST 3"},
		[0xe0] = {1, "RPO"},
		[0xe1] = {1, "POP H"},
		[0xe2] = {3, "JPO #$%02x%02x"},
		[0xe3] = {1, "XTHL"},
		[0xe4] = {3, "CPO #$%02x%02x"},
		[0xe5] = {1, "PUSH H"},
		[0xe6] = {2, "ANI $%02x"},
		[0xe7] = {1, "RST 4"},
		[0xe8] = {1, "RPE"},
		[0xe9] = {1, "PCHL"},
		[0xea] = {3, "JPE #$%02x%02x"},
		[0xeb] = {1, "XCHG"},
		[0xec] = {3, "CPE #$%02x%02x"},
		[0xed] = {1, "-"},
		[0xee] = {2, "XRI $%02x"},
		[0xef] = {1, "RST 5"},
		[0xf0] = {1, "RP"},
		[0xf1] = {1, "POP PSW"},
		[0xf2] = {3, "JP #$%02x%02x"},
		[0xf3] = {1, "DI"},
		[0xf4] = {3, "CP #$%02x%02x"},
		[0xf5] = {1, "PUSH PSW"},
		[0xf6] = {2, "ORI $%02x"},
		[0xf7] = {1, "RST 6"},
		[0xf8] = {1, "RM"},
		[0xf9] = {1, "SPHL"},
		[0xfa] = {3, "JM #$%02x%02x"},
		[0xfb] = {1, "EI"},
		[0xfc] = {3, "CM #$%02x%02x"},
		[0xfd] = {1, "-"},
		[0xfe] = {2, "CPI $%02x"},
		[0xff] = {1, "RST 7"}
};

int main(int argc, char** argv) {
	const int fd = open(argv[1], O_RDONLY);

	if(fd < 0) {
		printf("Failed to open %s\n", argv[1]);
		return 1;
	}

	struct stat sb;
	if(fstat(fd, &sb) == -1) {
		printf("Couldn't get file size of %s\n", argv[1]);
		return 1;
	}

	unsigned char* bytecode = mmap(NULL, sb.st_size, PROT_READ, MAP_PRIVATE, fd, 0);
	if(bytecode == MAP_FAILED) {
		printf("Couldn't mmap %s\n", argv[1]);
		return 1;
	}

	int pc = 0;
	while(pc < sb.st_size) {
		// the 8080 has 16 bit address space
		printf("%04X: ", pc);

		struct OP op = lookup[bytecode[pc]];
		switch(op.size) {
			case 1: printf("%s", op.fmt); break;
			case 2: printf(op.fmt, bytecode[pc+1]); break;
			case 3: printf(op.fmt, bytecode[pc+2], bytecode[pc+1]); break;
		}

		printf("\n");

		pc += op.size;
	}
}
